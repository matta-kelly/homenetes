# ==============================================================================
# Immich Machine Learning Deployment
# ==============================================================================
# Handles face recognition, CLIP embeddings, smart search
# ==============================================================================

apiVersion: apps/v1
kind: Deployment
metadata:
  name: immich-ml
  labels:
    app.kubernetes.io/name: immich
    app.kubernetes.io/component: machine-learning
spec:
  replicas: 1
  strategy:
    type: RollingUpdate
  selector:
    matchLabels:
      app.kubernetes.io/name: immich
      app.kubernetes.io/component: machine-learning
  template:
    metadata:
      labels:
        app.kubernetes.io/name: immich
        app.kubernetes.io/component: machine-learning
    spec:
      containers:
        - name: machine-learning
          image: ghcr.io/immich-app/immich-machine-learning:release
          ports:
            - name: http
              containerPort: 3003
              protocol: TCP

          volumeMounts:
            - name: model-cache
              mountPath: /cache

          resources:
            requests:
              cpu: 100m
              memory: 512Mi
            limits:
              cpu: 4000m
              memory: 4Gi

          livenessProbe:
            httpGet:
              path: /ping
              port: http
            initialDelaySeconds: 60
            periodSeconds: 30

          readinessProbe:
            httpGet:
              path: /ping
              port: http
            initialDelaySeconds: 30
            periodSeconds: 10

      volumes:
        - name: model-cache
          persistentVolumeClaim:
            claimName: immich-model-cache
